<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Mac系统安装OpenResty及使用</title>
    <link href="/2022/03/17/Mac%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85OpenResty%E5%8F%8A%E4%BD%BF%E7%94%A8/"/>
    <url>/2022/03/17/Mac%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85OpenResty%E5%8F%8A%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p><a href="https://openresty.org/cn/installation.html">OpenResty官方安装文档</a>强烈推荐MacOS使用<a href="https://brew.sh/">homebrew</a>包管理工具安装 。但是，对于使用老版本Mac系统（如10.13.6）的用户来说不是很友好，安装过程可能会找不到各种依赖、变量等，不如手动编译源码安装OpenResty。<br>参考<a href="https://www.runoob.com/w3cnote/openresty-intro.html">Linux下安装OpenResty</a>在Mac上编译安装：</p><h1 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h1><p>安装OpenResty前确保当前机器有以下依赖库：<br>● perl 5.6.1+<br>● libreadline<br>● libpcre<br>● libssl</p><p>参考<a href="https://www.toutiao.com/i7064948180328202766/?group_id=7064948180328202766">Linux系统非root用户下安装Nginx</a>安装pcre和openssl即可。</p><h1 id="下载源码包、编译、安装"><a href="#下载源码包、编译、安装" class="headerlink" title="下载源码包、编译、安装"></a>下载源码包、编译、安装</h1><div class="code-wrapper"><pre><code class="hljs">wget https://openresty.org/download/openresty-1.19.3.2.tar.gztar xzvf openresty-1.19.3.2.tar.gz       # 解压cd openresty-1.19.3.2/ ./configuremake make install</code></pre></div><p>默认情况下程序会被安装到 &#x2F;usr&#x2F;local&#x2F;openresty 目录。<strong>该目录下的nginx目录就是独立的Nginx服务</strong>。</p><img src="/2022/03/17/Mac%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85OpenResty%E5%8F%8A%E4%BD%BF%E7%94%A8/1644593016315-29c058d3-c3ce-4b78-bc94-7c9906b05b29.png" class=""><h1 id="配置PATH环境变量"><a href="#配置PATH环境变量" class="headerlink" title="配置PATH环境变量"></a>配置PATH环境变量</h1><p>方便操作OpenResty，因为Nginx&#x2F;OpenResty发布包中并没有提供好的启动、停止脚本，配置完后，就可以在终端直接使用nginx命令了。</p><div class="code-wrapper"><pre><code class="hljs">vi ~/.zshrc#添加如下配置export PATH=/usr/local/openresty/nginx/sbin:$PATH</code></pre></div><h1 id="命令及参数详解"><a href="#命令及参数详解" class="headerlink" title="命令及参数详解"></a>命令及参数详解</h1><p>OpenResty 的原始启动命令为 nginx，其参数有-v、-t、-p、-c、-s 等，使用说明如下：</p><h2 id="v参数"><a href="#v参数" class="headerlink" title="-v参数"></a>-v参数</h2><p>表示查看Nginx版本</p><div class="code-wrapper"><pre><code class="hljs">➜  ~ nginx -vnginx version: openresty/1.13.6.2</code></pre></div><h2 id="c参数"><a href="#c参数" class="headerlink" title="-c参数"></a>-c参数</h2><p>指定一个Nginx配置文件来替换默认的Nginx配置文件</p><div class="code-wrapper"><pre><code class="hljs">#单独建一个目录，并在目录中创建logs和conf目录mkdir ~/Software/openresty/workcd ~/Software/openresty/workmkdir logs/ conf/</code></pre></div><p>在conf目录下，定义一个后缀为.conf的文件，文件内容如下</p><div class="code-wrapper"><pre><code class="hljs">worker_processes  1;error_log logs/error.log;events &#123;    worker_connections 1024;&#125;http &#123;    server &#123;        listen 8080;        location / &#123;            default_type text/html;            content_by_lua &#39;                ngx.say(&quot;&lt;p&gt;Hello, World!&lt;/p&gt;&quot;)            &#39;;        &#125;    &#125;&#125;</code></pre></div><p>启动Nginx：</p><div class="code-wrapper"><pre><code class="hljs">#若在上一步新建的目录下：cd ~/Software/openresty/work#执行下面的命令启动➜  work nginx -p ./ -c conf/nginx.conf #若在其他目录，比如用户目录➜  ~ nginx -c ~/Software/openresty/work/conf/nginx.conf </code></pre></div><img src="/2022/03/17/Mac%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85OpenResty%E5%8F%8A%E4%BD%BF%E7%94%A8/1644594219385-db85a29b-01e6-4282-886b-29d19cb6d425.png" class=""><h2 id="p参数"><a href="#p参数" class="headerlink" title="-p参数"></a>-p参数</h2><p><strong>表示设置前缀路径</strong><br>“-p .&#x2F;”表示将当前目录作为前缀路径，也就是说-c后面指定的配置文件conf&#x2F;nginx.conf中，所用到的相对路径都加上这个前缀。<br>“-p .&#x2F;“ 等价于 “-p <code>pwd</code>&#x2F;“</p><h2 id="t参数"><a href="#t参数" class="headerlink" title="-t参数"></a>-t参数</h2><p><strong>表示测试Nginx配置文件语法是否正确</strong><br>若不能确定编写的Nginx配置文件语法的正确性，就使用-t参数，指定某个配置文件进行检测。不加配置文件路径，默认检测Nginx服务目录下的配置文件。</p><img src="/2022/03/17/Mac%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85OpenResty%E5%8F%8A%E4%BD%BF%E7%94%A8/1644594581627-4c4703be-d9f2-4a15-b49b-bdd8eeae324b.png" class=""><h2 id="s参数"><a href="#s参数" class="headerlink" title="-s参数"></a>-s参数</h2><p><strong>表示给Nginx进程发送信号，包含stop(停止)、reload（重新加载）</strong></p><div class="code-wrapper"><pre><code class="hljs">➜  ~ nginx -p ~/Software/openresty/work/ -c conf/nginx.conf -s reload➜  ~ ➜  ~ ps -ef|grep nginx                                                   0  1564     1   0 11:09下午 ??         0:00.00 nginx: master process nginx    -2  1565  1564   0 11:09下午 ??         0:00.00 nginx: worker process    0  2345     1   0 11:40下午 ??         0:00.01 nginx: master process nginx -p ./ -c conf/nginx.conf        -2  2833  2345   0 11:51下午 ??         0:00.00 nginx: worker process        501  2845   495   0 11:51下午 ttys000    0:00.00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn --exclude-dir=.idea --exclude-dir=.tox nginx➜  ~ ➜  ~ ➜  ~ nginx -p ~/Software/openresty/work/ -c conf/nginx.conf -s stop  ➜  ~ ➜  ~ ps -ef|grep nginx    0  1564     1   0 11:09下午 ??         0:00.00 nginx: master process nginx    -2  1565  1564   0 11:09下午 ??         0:00.00 nginx: worker process    501  2882   495   0 11:52下午 ttys000    0:00.00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn --exclude-dir=.idea --exclude-dir=.tox nginx➜  ~ </code></pre></div><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>终端下输入curl <a href="http://localhost:8080/">http://localhost:8080</a></p><div class="code-wrapper"><pre><code class="hljs">➜  ~ curl http://localhost:8080&lt;p&gt;Hello, World!&lt;/p&gt;➜  ~ </code></pre></div>]]></content>
    
    
    
    <tags>
      
      <tag>Nginx/OpenResty</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>使用非root用户停止和启动Apache、Nginx的方法</title>
    <link href="/2019/12/31/%E4%BD%BF%E7%94%A8%E9%9D%9Eroot%E7%94%A8%E6%88%B7%E5%81%9C%E6%AD%A2%E5%92%8C%E5%90%AF%E5%8A%A8Apache%E3%80%81Nginx%E7%9A%84%E6%96%B9%E6%B3%95/"/>
    <url>/2019/12/31/%E4%BD%BF%E7%94%A8%E9%9D%9Eroot%E7%94%A8%E6%88%B7%E5%81%9C%E6%AD%A2%E5%92%8C%E5%90%AF%E5%8A%A8Apache%E3%80%81Nginx%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<p>Apache或Nginx运行时会监听80或者443端口，root权限被回收后，修改配置文件需要重启的情况下，可以通过给二进制文件set UID的方式实现。</p><h1 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h1><p>root用户登录进入到&#x2F;opt&#x2F;apache&#x2F;bin目录下</p><div class="code-wrapper"><pre><code class="hljs"># cd /opt/apache/bin# chown root httpd# chmod u+s httpd# su - chatweb$ ll httpd -rwsr-xr-x 1 root chatweb 1546353 2017-08-14 httpd$ /opt/apache/bin/apachectl start</code></pre></div><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><p>root用户进入&#x2F;…&#x2F;nginx&#x2F;sbin目录下</p><div class="code-wrapper"><pre><code class="hljs"># cd /.../nginx/sbin# chown root nginx# chmod u+s nginx# su - nginx$ ll nginx-rwsr-xr-x 1 root nginx 3289160 2019-05-05 nginx$ /.../nginx/sbin/nginx -s reload</code></pre></div><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>Linux系统中的文件除了user id和group id外，还有俩称之为effective的id，四个id简写为uid、gid和euid、egid。<br>内核主要是根据euid和egid来确定进程对资源的访问权限：</p><ul><li>一个进程如果没有SUID或SGID位，则euid&#x3D;uid egid&#x3D;gid，分别是运行这个程序的用户的uid和gid；  </li><li>如果一个程序设置了SUID，则euid和egid变成被运行的程序的所有者的uid和gid；  </li><li>SUID的优先级比SGID高，当一个可执行程序设置了SUID，则SGID会自动变成相应的egid</li></ul><p>set UID（SUID）的作用是让执行该命令的用户以该命令拥有者的权限去执行。假如启动命令的拥有者是root用户，普通用户执行命令时就会拥有root的权限，然后使用root权限去操作服务。<br>set UID的方式只针对二进制文件，是在执行程序（程序的可执行位被设置）时起作用，而可执行位只对普通文件和目录文件有意义。</p><p>给文件加或去掉SUID和SGID的命令如下：</p><div class="code-wrapper"><pre><code class="hljs"># chmod u+s filename 设置SUID位# chmod u-s filename 去掉SUID设置# chmod g+s filename 设置SGID位# chmod g-s filename 去掉SGID设置</code></pre></div><p>如果一个文件被设置了SUID或SGID位，会分别表现在所有者或同组用户的权限的可执行位上。例如：<br>1、-rwsr-xr-x 表示SUID和所有者权限中可执行位被设置<br>2、-rwSr–r– 表示SUID被设置，但所有者权限中可执行位没有被设置<br>3、-rwxr-sr-x 表示SGID和同组用户权限中可执行位被设置<br>4、-rw-r-Sr– 表示SGID被设置，但同组用户权限中可执行位没有被设置</p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
      <category>Nginx</category>
      
      <category>Apache</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Nginx/OpenResty</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux系统非root用户下安装Nginx</title>
    <link href="/2019/04/28/Linux%E7%B3%BB%E7%BB%9F%E9%9D%9Eroot%E7%94%A8%E6%88%B7%E4%B8%8B%E5%AE%89%E8%A3%85Nginx/"/>
    <url>/2019/04/28/Linux%E7%B3%BB%E7%BB%9F%E9%9D%9Eroot%E7%94%A8%E6%88%B7%E4%B8%8B%E5%AE%89%E8%A3%85Nginx/</url>
    
    <content type="html"><![CDATA[<p>通常使用Nginx或者Apache作为Web服务器时，默认监听80端口，因此默认会使用root用户去安装，而且，使用yum命令安装时，通常会安装到默认的路径下，默认路径通常是root用户才有执行权限的。如果不需要使用Nginx监听1024以下的端口，且对权限和网络管理比较严格时，能用非root权限解决的，就用普通用户。在此使用编译Nginx源码的方式安装Nginx。 假设已拿到root用户权限，但需要使用普通用户去管理Nginx。</p><h1 id="登录Linux服务器"><a href="#登录Linux服务器" class="headerlink" title="登录Linux服务器"></a>登录Linux服务器</h1><p>root登录服务器<br>    ssh <a href="mailto:&#114;&#111;&#111;&#x74;&#64;&#x78;&#x2e;&#x78;&#x2e;&#x78;&#x2e;&#x78;">&#114;&#111;&#111;&#x74;&#64;&#x78;&#x2e;&#x78;&#x2e;&#x78;&#x2e;&#x78;</a></p><h1 id="创建普通用户并设置密码"><a href="#创建普通用户并设置密码" class="headerlink" title="创建普通用户并设置密码"></a>创建普通用户并设置密码</h1><p>创建普通用户</p><div class="code-wrapper"><pre><code class="hljs"># useradd nginx</code></pre></div><p>为nginx用户设置密码为nginx#123</p><div class="code-wrapper"><pre><code class="hljs"># echo nginx#123|passwd --stdin nginx</code></pre></div><p>创建完毕用户后，切换到nginx用户</p><div class="code-wrapper"><pre><code class="hljs"># su nginx</code></pre></div><p>进入用户目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd ~</code></pre></div><h1 id="安装openssl"><a href="#安装openssl" class="headerlink" title="安装openssl"></a>安装openssl</h1><p><a href="https://www.openssl.org/source/">下载地址</a></p><p>进入用户目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd ~</code></pre></div><p>删除原有安装（如果有的话）</p><div class="code-wrapper"><pre><code class="hljs">$ rm -rf openssl$ rm -rf openssl-1.1.0j #（以机器上实际安装的为准）</code></pre></div><p>解压</p><div class="code-wrapper"><pre><code class="hljs">$ tar -zxv -f openssl-1.1.0j.tar.gz</code></pre></div><p>进入源码目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd openssl-1.1.0j</code></pre></div><p>配置<br>注意，prefix和opensslsir的值要写绝对路径，不能是相对路径，表示编译后的地址</p><div class="code-wrapper"><pre><code class="hljs">$ ./config --prefix=/home/nginx/openssl --openssldir=/home/nginx/openssl/conf</code></pre></div><p>编译安装</p><div class="code-wrapper"><pre><code class="hljs">$ make &amp;&amp; make install</code></pre></div><p>检查安装</p><div class="code-wrapper"><pre><code class="hljs">$ cd /home/nginx/openssl/bin$ openssl version -a</code></pre></div><h1 id="安装pcre"><a href="#安装pcre" class="headerlink" title="安装pcre"></a>安装pcre</h1><p>下载地址：<br><a href="https://sourceforge.net/projects/pcre/">https://sourceforge.net/projects/pcre/</a></p><p>进入安装目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd ~</code></pre></div><p>删除原有安装（如果有的话）</p><div class="code-wrapper"><pre><code class="hljs">$ rm -rf pcre$ rm -rf pcre-8.43 （以机器上实际安装的为准）</code></pre></div><p>解压</p><div class="code-wrapper"><pre><code class="hljs">$ tar -zxv -f pcre-8.43.tar.gz</code></pre></div><p>进入源码目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd pcre-8.43</code></pre></div><p>执行配置</p><div class="code-wrapper"><pre><code class="hljs">$./configure --prefix=/home/nginx/pcre/</code></pre></div><p>编译安装</p><div class="code-wrapper"><pre><code class="hljs">$ make &amp;&amp; make install</code></pre></div><h1 id="安装zlib"><a href="#安装zlib" class="headerlink" title="安装zlib"></a>安装zlib</h1><p>下载地址：<a href="http://zlib.net/">http://zlib.net/</a></p><p>进入安装目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd ~</code></pre></div><p>删除原有安装（如果有的话）</p><div class="code-wrapper"><pre><code class="hljs">$ rm -rf zlib$ rm -rf zlib-1.2.11（以机器上实际安装的为准）</code></pre></div><p>解压</p><div class="code-wrapper"><pre><code class="hljs">$ tar -zxv -f zlib-1.2.11.tar.gz</code></pre></div><p>进入源码目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd zlib-1.2.11</code></pre></div><p>配置</p><div class="code-wrapper"><pre><code class="hljs">$./configure --prefix=/home/nginx/zlib/</code></pre></div><p>编译安装</p><div class="code-wrapper"><pre><code class="hljs">$ make &amp;&amp; make install</code></pre></div><h1 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h1><p>下载地址：<a href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a></p><p>进入安装目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd ~</code></pre></div><p>删除原有安装（如果有的话）</p><div class="code-wrapper"><pre><code class="hljs">$ rm -rf nginx$ rm -rf nginx-1.14.2</code></pre></div><p>解压</p><div class="code-wrapper"><pre><code class="hljs">$ tar -zxvf nginx-1.14.2.tar.gz</code></pre></div><p>进入安装目录</p><div class="code-wrapper"><pre><code class="hljs">$ cd nginx-1.14.2</code></pre></div><p>配置(使用openssl、pcre、zlib的源码路径)</p><div class="code-wrapper"><pre><code class="hljs">$ ./configure \--user=nginx \--group=nginx \--prefix=/home/nignx/nginx \--with-http_ssl_module \--with-openssl=/home/nignx/openssl-1.1.0j \--with-pcre=/home/nignx/pcre-8.43 \--with-zlib=/home/nignx/zlib-1.2.11 \--with-http_stub_status_module \--with-threads</code></pre></div><p>编译安装</p><div class="code-wrapper"><pre><code class="hljs">$ make &amp;&amp; make install</code></pre></div><p>修改监听端口为非1024</p><div class="code-wrapper"><pre><code class="hljs">$ vi ~/nginx/conf/nginx.confserver &#123;    listen      8089;    server_name localhost;    location &#123;        root    html;        index   index.html  index.htm;    &#125;&#125;</code></pre></div><p>验证</p><div class="code-wrapper"><pre><code class="hljs">$ /home/nginx/nginx/sbin/nginx -Vnginx version: nginx/1.14.2built by gcc 4.4.7 20120313 (Red Hat 4.4.7-11) (GCC) built with OpenSSL 1.1.0j  20 Nov 2018TLS SNI support enabledconfigure arguments: --user=nginx --group=nginx --prefix=/home/nginx/nginx --with-http_ssl_module --with-openssl=/home/nginx/openssl-1.1.0j --with-pcre=/home/nginx/pcre-8.43 --with-zlib=/home/nginx/zlib-1.2.11 --with-http_stub_status_module --with-threads</code></pre></div><h1 id="启动、重启、停止"><a href="#启动、重启、停止" class="headerlink" title="启动、重启、停止"></a>启动、重启、停止</h1><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><div class="code-wrapper"><pre><code class="hljs">$ /home/nginx/nginx/sbin/nginx</code></pre></div><h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><div class="code-wrapper"><pre><code class="hljs">$ /home/nginx/nginx/sbin/nginx -s reload</code></pre></div><h2 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h2><p>查询nginx主进程号</p><div class="code-wrapper"><pre><code class="hljs">$ ps -ef | grep nginx</code></pre></div><p>停止进程</p><div class="code-wrapper"><pre><code class="hljs">$ kill -QUIT 主进程号</code></pre></div><p>快速停止</p><div class="code-wrapper"><pre><code class="hljs">$ kill -TERM 主进程号</code></pre></div><p>强制停止</p><div class="code-wrapper"><pre><code class="hljs">$ pkill -9 nginx</code></pre></div><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>测试端口</p><div class="code-wrapper"><pre><code class="hljs">$ netstat –na|grep 8089</code></pre></div><p>浏览器中测试<br>    $ curl localhost:8089</p>]]></content>
    
    
    
    <tags>
      
      <tag>Nginx/OpenResty</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
